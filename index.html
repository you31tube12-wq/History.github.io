<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>សំនួរ-ចម្លើយ ប្រវត្តិវិទ្យា</title>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --main: #4f46e5; --bg: #f8fafc; --accent: #d4af37; }
        body { font-family: 'Kantumruy Pro', sans-serif; background: var(--bg); margin: 0; color: #1e293b; }
        nav { background: white; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        header { background: linear-gradient(135deg, #4f46e5, #1e1b4b); color: white; padding: 60px 20px; text-align: center; border-radius: 0 0 40px 40px; }
        .container { max-width: 900px; margin: -30px auto 100px; padding: 0 20px; }
        
        /* Ad Popup Styling */
        .ad-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 9999; justify-content: center; align-items: center; }
        .ad-box { background: white; width: 90%; max-width: 450px; padding: 30px; border-radius: 30px; text-align: center; position: relative; animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .ad-box h2 { color: var(--main); margin-top: 0; }
        .ad-links { display: flex; flex-direction: column; gap: 10px; }
        .ad-link-btn { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 12px; border-radius: 12px; background: #0088cc; color: white; text-decoration: none; font-weight: 600; transition: 0.3s; }
        .close-ad { margin-top: 20px; background: #f1f5f9; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; width: 100%; font-family: 'Kantumruy Pro'; }

        .search-area { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .search-box { display: flex; align-items: center; border: 1px solid #e2e8f0; border-radius: 12px; padding: 0 15px; margin-bottom: 15px; }
        .search-box input { border: none; outline: none; width: 100%; padding: 12px; font-family: 'Kantumruy Pro'; }
        .filter-tabs { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .tab { padding: 8px 18px; background: #f1f5f9; border-radius: 10px; cursor: pointer; font-size: 0.9rem; white-space: nowrap; transition: 0.3s; border: none; font-family: 'Kantumruy Pro'; }
        .tab.active { background: var(--main); color: white; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.02); transition: 0.3s; border: 1px solid #f1f5f9; position: relative; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
        .grade-badge { background: #eef2ff; color: var(--main); font-size: 11px; font-weight: 700; padding: 4px 10px; border-radius: 8px; position: absolute; top: 20px; right: 20px; }
        .btn { border: none; padding: 12px; border-radius: 12px; cursor: pointer; font-family: 'Kantumruy Pro'; font-weight: 600; width: 100%; margin-top: 10px; }
        .btn-main { background: var(--main); color: white; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 1000; }
        .modal-content { background: white; max-width: 650px; margin: 40px auto; padding: 30px; border-radius: 25px; position: relative; max-height: 85vh; overflow-y: auto; }
        input, textarea, select { width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 10px; border: 1px solid #ddd; font-family: 'Kantumruy Pro'; box-sizing: border-box; }
    </style>
</head>
<body onload="loadAd()">

<div id="adOverlay" class="ad-overlay">
    <div class="ad-box">
        <i class="fab fa-telegram" style="font-size: 3rem; color: #0088cc; margin-bottom: 15px;"></i>
        <h2 id="displayAdTitle">ចូលរួមជាមួយពួកយើង</h2>
        <p id="displayAdDesc">សូមចុច Subscribe Channels ខាងក្រោមដើម្បីទទួលបានវិញ្ញាសា!</p>
        <div class="ad-links" id="displayAdLinks"></div>
        <button class="close-ad" onclick="closeAd()">ចូលទៅកាន់បណ្ណាល័យ</button>
    </div>
</div>

<nav>
    <div style="font-weight: 700; color: var(--main); font-size: 1.2rem;"><i class="fas fa-history"></i> សំនួរ-ចម្លើយ ប្រវត្តិវិទ្យា</div>
    <button onclick="loginAdmin()" style="border:none; background:none; color:#64748b; cursor:pointer;"><i class="fas fa-user-lock"></i></button>
</nav>

<header>
    <h1>វិមានសំនួរ-ចម្លើយ ប្រវត្តិវិទ្យា</h1>
    <p>ស្វែងរកវិញ្ញាសា និងមេរៀនសង្ខេប ថ្នាក់ទី ៩ ដល់ទី ១២</p>
</header>

<div class="container">
    <div class="search-area">
        <div class="search-box">
            <i class="fas fa-search" style="color: #94a3b8;"></i>
            <input type="text" id="search" placeholder="ស្វែងរកសំនួរ ឬប្រធានបទ..." onkeyup="render()">
        </div>
        <div class="filter-tabs" id="gradeFilter">
            <button class="tab active" onclick="filterGrade('ទាំងអស់')">ទាំងអស់</button>
            <button class="tab" onclick="filterGrade('ថ្នាក់ទី ៩')">ថ្នាក់ទី ៩</button>
            <button class="tab" onclick="filterGrade('ថ្នាក់ទី ១០')">ថ្នាក់ទី ១០</button>
            <button class="tab" onclick="filterGrade('ថ្នាក់ទី ១១')">ថ្នាក់ទី ១១</button>
            <button class="tab" onclick="filterGrade('ថ្នាក់ទី ១២')">ថ្នាក់ទី ១២</button>
        </div>
    </div>
    
    <div id="adminPanel" style="display: none; margin-bottom: 20px; text-align: right;">
        <button class="btn-main" style="width: auto; padding: 10px 25px; background: #10b981;" onclick="openAdManager()">⚙️ កែពាណិជ្ជកម្ម</button>
        <button class="btn-main" style="width: auto; padding: 10px 25px;" onclick="openForm('add')">+ បន្ថែមសំនួរថ្មី</button>
        <button onclick="logout()" style="margin-left:10px; border:none; background:none; color:#ef4444; cursor:pointer;">ចាកចេញ</button>
    </div>

    <div class="grid" id="essayGrid"></div>
</div>

<div id="mainModal" class="modal">
    <div class="modal-content">
        <span onclick="closeModal()" style="position:absolute; top:15px; right:20px; cursor:pointer; font-size:1.5rem;">&times;</span>
        <h2 id="mTitle" style="color:var(--main); margin-top: 0; padding-right: 20px;"></h2>
        <hr style="border: 0; height: 1px; background: #f1f5f9; margin: 15px 0;">
        <div id="mBody"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, set, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD0CoOErw8unJ2lGF3K4BqTAnq0eFq3ycI",
        authDomain: "myessayapp.firebaseapp.com",
        databaseURL: "https://myessayapp-default-rtdb.firebaseio.com",
        projectId: "myessayapp",
        storageBucket: "myessayapp.firebasestorage.app",
        messagingSenderId: "410054064875",
        appId: "1:410054064875:web:7d073851f478564eb39cae"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const essayRef = ref(db, 'history_qa'); // ប្តូរ Node ទៅជា history_qa
    const adRef = ref(db, 'ads_config');

    let essays = [];
    let isAdmin = false;
    let editId = null;
    let currentGradeFilter = 'ទាំងអស់';
    let adConfig = { title: '', desc: '', buttons: [{},{},{},{},{}] };

    window.loadAd = function() {
        onValue(adRef, (snapshot) => {
            const data = snapshot.val();
            if(data) {
                adConfig = data;
                document.getElementById('displayAdTitle').innerText = data.title;
                document.getElementById('displayAdDesc').innerText = data.desc;
                let btnHtml = '';
                data.buttons.forEach(b => {
                    if(b.text && b.url) btnHtml += `<a href="${b.url}" target="_blank" class="ad-link-btn"><i class="fas fa-link"></i> ${b.text}</a>`;
                });
                document.getElementById('displayAdLinks').innerHTML = btnHtml;
            }
            document.getElementById('adOverlay').style.display = 'flex';
        });
    }

    window.closeAd = function() { document.getElementById('adOverlay').style.display = 'none'; }

    window.openAdManager = function() {
        document.getElementById('mTitle').innerText = "កំណត់ផ្ទាំងពាណិជ្ជកម្ម";
        let btnInputs = '';
        for(let i=0; i<5; i++) {
            let b = adConfig.buttons[i] || {text:'', url:''};
            btnInputs += `<div style="padding:10px; border:1px solid #eee; margin-bottom:10px; border-radius:10px;"><label>ប៊ូតុងទី ${i+1}</label><input type="text" id="btnT${i}" value="${b.text || ''}" placeholder="ឈ្មោះប៊ូតុង"><input type="text" id="btnU${i}" value="${b.url || ''}" placeholder="Link (URL)"></div>`;
        }
        document.getElementById('mBody').innerHTML = `<input type="text" id="adT" value="${adConfig.title}" placeholder="ចំណងជើងធំ"><textarea id="adD" placeholder="អត្ថបទរៀបរាប់">${adConfig.desc}</textarea>${btnInputs}<button class="btn btn-main" onclick="saveAdConfig()">រក្សាទុកពាណិជ្ជកម្ម</button>`;
        document.getElementById('mainModal').style.display = 'block';
    }

    window.saveAdConfig = function() {
        let btns = [];
        for(let i=0; i<5; i++) { btns.push({ text: document.getElementById(`btnT${i}`).value, url: document.getElementById(`btnU${i}`).value }); }
        set(adRef, { title: document.getElementById('adT').value, desc: document.getElementById('adD').value, buttons: btns });
        closeModal();
    }

    onValue(essayRef, (snapshot) => {
        const data = snapshot.val();
        essays = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
        render();
    });

    window.filterGrade = function(grade) {
        currentGradeFilter = grade;
        document.querySelectorAll('.tab').forEach(t => { t.classList.toggle('active', t.innerText === grade); });
        render();
    }

    window.render = function() {
        const grid = document.getElementById('essayGrid');
        grid.innerHTML = '';
        const searchVal = document.getElementById('search').value.toLowerCase();
        const filtered = essays.filter(e => (e.title.toLowerCase().includes(searchVal)) && (currentGradeFilter === 'ទាំងអស់' || e.grade === currentGradeFilter));
        filtered.forEach(e => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `<div class="grade-badge">${e.grade}</div><h3 style="margin:20px 0 15px 0; font-size:1.1rem; line-height:1.6;">${e.title}</h3><button class="btn btn-main" onclick="view('${e.id}')">មើលចម្លើយ</button>${isAdmin ? `<div style="display:flex; gap:10px; margin-top:10px;"><button class="btn" style="background:#f1f5f9" onclick="openForm('edit','${e.id}')">កែ</button><button class="btn" style="background:#fef2f2; color:#ef4444" onclick="del('${e.id}')">លុប</button></div>` : ''}`;
            grid.appendChild(card);
        });
    }

    window.save = function() {
        const title = document.getElementById('fTitle').value;
        const content = document.getElementById('fContent').value;
        const grade = document.getElementById('fGrade').value;
        if (!title || !content) return alert("សូមបំពេញឱ្យគ្រប់!");
        if (editId) set(ref(db, 'history_qa/' + editId), { title, content, grade });
        else push(essayRef, { title, content, grade });
        closeModal();
    }

    window.del = function(id) { if(confirm("លុបសំនួរនេះ?")) remove(ref(db, 'history_qa/' + id)); }
    window.view = function(id) {
        const e = essays.find(x => x.id === id);
        document.getElementById('mTitle').innerText = e.title;
        document.getElementById('mBody').innerHTML = `<div style="margin-bottom:15px; color:var(--main); font-weight:700;">កម្រិត៖ ${e.grade}</div><div style="white-space:pre-line; line-height:1.8; color:#334155; font-size:1.1rem; background:#f1f5f9; padding:20px; border-radius:15px; border-left:5px solid var(--main);">${e.content}</div>`;
        document.getElementById('mainModal').style.display = 'block';
    }
    window.openForm = function(mode, id = null) {
        editId = id;
        const e = id ? essays.find(x => x.id === id) : {title:'', content:'', grade:'ថ្នាក់ទី ៩'};
        document.getElementById('mTitle').innerText = mode === 'add' ? "បន្ថែមសំនួរ-ចម្លើយ" : "កែសម្រួល";
        document.getElementById('mBody').innerHTML = `<select id="fGrade"><option ${e.grade==='ថ្នាក់ទី ៩'?'selected':''}>ថ្នាក់ទី ៩</option><option ${e.grade==='ថ្នាក់ទី ១០'?'selected':''}>ថ្នាក់ទី ១០</option><option ${e.grade==='ថ្នាក់ទី ១១'?'selected':''}>ថ្នាក់ទី ១១</option><option ${e.grade==='ថ្នាក់ទី ១២'?'selected':''}>ថ្នាក់ទី ១២</option></select><input type="text" id="fTitle" value="${e.title}" placeholder="បញ្ចូលសំនួរ..."><textarea id="fContent" rows="12" placeholder="បញ្ចូលចម្លើយ...">${e.content}</textarea><button class="btn btn-main" onclick="save()">រក្សាទុក</button>`;
        document.getElementById('mainModal').style.display = 'block';
    }
    window.loginAdmin = function() { if(prompt("លេខសម្ងាត់ Admin:") === "0319995568") { isAdmin = true; document.getElementById('adminPanel').style.display = 'block'; render(); } }
    window.logout = function() { isAdmin = false; document.getElementById('adminPanel').style.display = 'none'; render(); }
    window.closeModal = function() { document.getElementById('mainModal').style.display = 'none'; }
</script>
</body>
</html>
